# Generated by Django 2.2.24 on 2021-10-10 09:32

from django.db import migrations

# Must import to use treebeard API
# This is important now, but in future when we don't need to try and
# support upgrading from the current version any more, we can remove this assertion.
from wazimap_ng.datasets.models import GeographyHierarchy

def assert_unique_version_per_hierarchy(app, schema_editor):
    for hierarchy in GeographyHierarchy.objects.all():
        unique_versions = hierarchy.root_geography.get_descendants().values('version').order_by().distinct()
        if unique_versions.count() > 1:
            raise Exception(f"Hierarchy {hierarchy} has {unique_versions.count()} unique versions which means we'll lose data if we assume the entire hierarchy has the same version as the root node in the next migration.")


class Migration(migrations.Migration):

    dependencies = [
        ('datasets', '0116_auto_20210803_2049'),
    ]

    operations = [
        migrations.RunPython(assert_unique_version_per_hierarchy)
    ]
