# Generated by Django 2.2.24 on 2022-01-19 10:26

from django.db import migrations


def port_admin_log_to_simple_history(apps, schema_editor):
    LogEntry = apps.get_model("admin", "LogEntry")

    for log_entry in LogEntry.objects.all():
        ct = log_entry.content_type
        instance_model = apps.get_model(ct.app_label, ct.model)
        try:
            instance = instance_model.objects.get(id=log_entry.object_id)
        except instance_model.DoesNotExist:
            continue

        try:
            manager = instance.history
        except AttributeError:
            continue

        action_type = None
        history_type = None
        if log_entry.action_flag == 1:
            action_type = "created"
            history_type = "+"
        elif log_entry.action_flag == 2:
            action_type = "updated"
            history_type = "~"
        else:
            continue

        attrs = {}
        fields = instance._meta.fields
        for field in fields:
        	attrs[field.attname] = getattr(instance, field.attname)

        history_date = getattr(instance, action_type, timezone.now())
        history_user = log_entry.user
        history_change_reason = log_entry.get_change_message()
        history_type = history_type

        history_instance = manager.model(
            history_date=history_date,
            history_type=history_type,
            history_user=history_user,
            history_change_reason=history_change_reason,
            **attrs,
        )
        history_instance.save()

class Migration(migrations.Migration):

    dependencies = [
        ('datasets', '0126_auto_20211111_0413'),
    ]

    operations = [
        migrations.RunPython(port_admin_log_to_simple_history),
    ]
